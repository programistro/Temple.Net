@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using OpenStreetMapForBlazor
@using Temple.Net.Models
@inject IConfiguration config
@inject IJSRuntime JSRuntime
@inject AppDbContext _context
@using Newtonsoft.Json
@using Temple.Blazor.Net.Components.Layout
@using Temple.Net.Service
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<MudPopoverProvider @rendermode="InteractiveServer"/>
<MudSnackbarProvider @rendermode="InteractiveServer"/>

<MudContainer MaxWidth="MaxWidth.Large" Style="width: 45%; margin-bottom: 20px;">
    <MudCard>
        <MudCardContent>
            <h5 class="card-title text-center mb-3 fw-light fs-5">Добавить храм</h5>
            <div>
                <MudTextField @bind-Value="_temple.Name" Label="Название"/>
            </div>

            <div>
                <MudAutocomplete T="string" Label="Тип храма" @bind-Value="selectedType" SearchFunc="@SearchType"
                                 ResetValueOnEmptyText="@resetValueOnEmptyText"
                                 CoerceText="@coerceText" CoerceValue="@coerceValue" AdornmentColor="Color.Primary" />
            </div>

            <div style="margin-top: 10px; margin-bottom: 10px;">
                <MudDatePicker TValue="DateTime?" DateFormat="dd.MM.yyyy"
                               Placeholder="Год основания" @bind-Date="_temple.DateStart" Label="Год основания"/>
            </div>

            <div>
                <div>

                    <div style="margin-top: 10px; margin-bottom: 10px;">
                        <MudDatePicker TValue="DateTime?" DateFormat="dd.MM.yyyy"
                                       Label="Год закрытия" @bind-Date="_temple.DateEnd"/>
                    </div>

                    <div style="margin-top: 10px; margin-bottom: 10px;">
                        <MudDatePicker TValue="DateTime?" DateFormat="dd.MM.yyyy" Label="Год приспособления"
                                       @bind-Date="_temple.YearAdaptation"/>
                    </div>

                    <MudAutocomplete T="string" Label="Назначение после закрытия" @bind-Value="selectedAfterClosing" SearchFunc="@SearchAfterClosing"
                                     ResetValueOnEmptyText="@resetValueOnEmptyText"
                                     CoerceText="@coerceText" CoerceValue="@coerceValue" AdornmentColor="Color.Primary" />
                    
                </div>
            </div>

            <div style="margin-top: 10px; margin-bottom: 10px;">
                <MudDatePicker TValue="DateTime?" DateFormat="dd.MM.yyyy" Label="Год уничтожения" @bind-Date="_temple.YearDestruction" />
            </div>

            <div>
                <h3 class="card-title text-center mb-3 fw-light fs-5">Церковная ориентация</h3>

                <div>
                    <div style="margin-top: 10px; margin-bottom: 10px;">
                        <MudDatePicker TValue="DateTime?" DateFormat="dd.MM.yyyy" Label="Год отпадения" @bind-Date="_temple.Oriention.YearFall" />
                    </div>

                    <MudAutocomplete T="string" Label="Церковная ориентация" @bind-Value="selectedOriention" SearchFunc="@SearchOriention"
                                     ResetValueOnEmptyText="@resetValueOnEmptyText"
                                     CoerceText="@coerceText" CoerceValue="@coerceValue" AdornmentColor="Color.Primary" />

                    <div style="margin-top: 10px; margin-bottom: 10px;">
                        <MudDatePicker DateFormat="dd.MM.yyyy" Label="Год возрата" @bind-Date="_temple.Oriention.YearRefund"/>
                    </div>
                </div>
            </div>

            <div>
                <h3 class="card-title text-center mb-3 fw-light fs-5">Количество прихожан</h3>

                <div>
                    <div style="margin-top: 10px; margin-bottom: 10px;">
                        <MudDatePicker DateFormat="dd.MM.yyyy" Label="Год" @bind-Date="_temple.ParshYear"/>
                    </div>

                    <MudTextField T="int?" @bind-value="_temple.Quantity" Label="Количество"/>
                </div>
            </div>

            <div>
                <h3 class="card-title text-center mb-3 fw-light fs-5">Епархии</h3>
                
                <MudAutocomplete T="string" Label="Епархии" @bind-Value="selectedDiocese" SearchFunc="@SearcDiocese"
                                 ResetValueOnEmptyText="@resetValueOnEmptyText"
                                 CoerceText="@coerceText" CoerceValue="@coerceValue" AdornmentColor="Color.Primary" />
            </div>

                <MudAutocomplete T="string" Label="Губернии и уезды" @bind-Value="selectedProvince" SearchFunc="@SearchProvince"
                                 ResetValueOnEmptyText="@resetValueOnEmptyText"
                                 CoerceText="@coerceText" CoerceValue="@coerceValue" />
            
            <div>
                <MudAutocomplete T="string" Label="Округа и районы округов (1924-1930)" @bind-Value="selectedDistrict" SearchFunc="@SearchDistrict"
                                 ResetValueOnEmptyText="@resetValueOnEmptyText"
                                 CoerceText="@coerceText" CoerceValue="@coerceValue" />
            </div>

            <div>
                <div style="height: 500px; margin-top: 20px;">
                    <OSMap Click="@MapClickEvent" CenterMap="@defPosition" />
                </div>
            </div>

            <div class="d-grid mb-2">
                <MudButton Style="margin-top: 20px;" Color="Color.Primary" Variant="Variant.Filled" OnClick="Sumbit">Добавить</MudButton>
            </div>
        </MudCardContent>
    </MudCard>
</MudContainer>
 
@code {
    public MapPosition position;
    public bool btnActive;

    MapPosition? defPosition;

    private string selectedType;

    private string selectedOriention;

    private string selectedDiocese;

    private string selectedDistrict;

    private string selectedProvince;

    private string selectedAfterClosing;

    private Temple? _temple = new()
    {
        AppointmentsAfterEnd = new()
        {
            Id = Guid.NewGuid().ToString("N")
        },
        Oriention = new()
        {
            Id = Guid.NewGuid().ToString("N")
        },
        Id = Guid.NewGuid().ToString("N")
    };

    protected override void OnInitialized()
    {
        defPosition = new MapPosition() { Lat = config.GetValue<double>("Main:DefLat"), Lng = config.GetValue<double>("Main:DefLng") };
    }

    public void MapClickEvent(MapClickEventArgs args)
    {
        //events.Add(DateTime.Now, $"Map clicked at Lat: {args.Position.Lat}, Lng: {args.Position.Lng}");

        if (args != null) position = args.Position;

        //btnActive = !(position.Lng == defPosition.Lng && position.Lat == defPosition.Lat);
        //actualJson = JsonConvert.SerializeObject(args);

        //StateHasChanged();
    }
    
    private string[] types =
    {
        "Кафедральный", "Кладбищенский", "Приходской"
    };

    private string[] afterClosing =
    {
        "Зернохранилище", "Клуб", "Склад"
    };

    private string[] oriention =
    {
        "Автокафельная", "Обновличенская", "Тихоновская"
    };
    /// <summary>
    /// Автокафельная
    /// </summary>
    private string[] dioceseAvto =
    {
        "Автокафельная"
    };
    
    private string[] dioceseObnov =
    {
        "Велижско-Высочанская", "Витебская", "Гомельская", "Минская", "Могилевская", "Мозырская", "Мстиславская",
        "Оршанская", "Полоцкая", "Слуцкая", "Чаусская"
    };

    private string[] dioceseTixo =
    {
        "Гомельская", "Могилевская и Мстиславская", "Минская и Туровская", "Минская", "Минская и Белорусская", 
        "Полоцкая и Витебская"
    };

    private string[] provinces =
    {
        "Велижский", "Витебский",  "Городоккский",  "Дриссенский",  "Лепельский",  "Невельский",  "Полоцкий",  "Себежский",  "Гомельская",  "Быховский",
        "Гомельский",  "Могилевский",  "Рогачевский",  "Чаусский",  "Чериковский",  "Горецкий",  "Климовический",  "Оршанской",  "Бобруйский",  "Борисовский",  "Игуменский",  "Минский",
        "Мозырский",  "Речицкий",  "Слуцкий",  "Быховский",  "Гомельский",  "Горецкий",  "Климовичский",  "Могилевский",  "Мстиславский",  "Оршанский",  "Рогачевский",  "Сенненский",
        "Чаусский",  "Чериковский"
    };

    string[] districts = new string[]
    {
        "Бобруйский", "Бобруйский 1-й", "Бобруйский 2-й", "Буда-Кошелевский", "Городецкий", "Глусский", "Жлобинский",
        "Кличевский", "Краснослободский", "Любанский", "Осиповичский", "Паричский", "Рогачевский", "Свислочский", "Слуцкий",
        "Старобинский", "Стародорожский", "Стрешинский", "Бегомльский", "Березинский", "Борисовский", "Зембинский", "Крупский",
        "Лепельский", "Плещеницкий", "Холопеничский", "Черейский", "Бешенковичский", "Витебский", "Высочанский", "Городокский",
        "Езерищенский", "Лиозненский", "Кузнецовский", "Межанский", "Сенненский", "Сиротинский", "Суражский", "Чашникский",
        "Белынковичский", "Климовичский", "Кастюковичский", "Краснопольский", "Кричевский", "Милославичский", "Мстиславский",
        "Расненский", "Хотимский", "Чериковский", "Белыничский", "Березинский", "Борисовский", "Журовичский", "Кастюковичский",
        "Климовичский", "Кормянский", "Краснопольский", "Кричевский", "Луполовский", "Милославичский", "Могилевский", "Пропойский",
        "Хотимский", "Чаусский", "Чериковский", "Чечевичский", "Шкловский", "Бегомльский", "Березинский", "Борисовский", "Гресский",
        "Койдановский", "Зембинский", "Койдановский", "Копыльский", "Острошицко-Городокский", "Плещеницкий", "Пуховичский",
        "Самохваловичский", "Смиловичский", "Смолевичский", "Узденский", "Червенский", "Холопеничский", "Шацкий", "Богушевский",
        "Горецкий", "Дрибинский", "Дубровенский", "Копысский", "Кохановский", "Круглянский", "Лядненский", "Мстиславский",
        "Оршанский", "Расненский", "Толочинский", "Ветринский", "Волынецкий", "Борковичский", "Дретунский", "Краснопольский",
        "Дриссенский", "Освейский", "Полоцкий", "Россонский", "Улльский", "Ушачский", "Гресский", "Копыльский", "Краснослободский",
        "Любанский", "Слуцкий", "Стародорожский", "Плещеницкий", "Старобинский", "Брагинский", "Василевичский", "Горвальский",
        "Комаринский", "Лоевский", "Речицкий", "Хойникский", "Холмечский", "Юровичский"
    };
    
    private bool coerceText;
    
    private bool coerceValue;
    
    private bool resetValueOnEmptyText;
    
    private async Task<IEnumerable<string>> SearchType(string value, CancellationToken token)
    {
        await Task.Delay(5, token);

        if (string.IsNullOrEmpty(value))
            return types;
        return types.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }

    private async Task<IEnumerable<string>> SearchAfterClosing(string value, CancellationToken token)
    {
        await Task.Delay(5, token);

        if (string.IsNullOrEmpty(value))
            return afterClosing;
        return afterClosing.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));   
    }

    private async Task<IEnumerable<string>> SearchOriention(string value, CancellationToken token)
    {
        await Task.Delay(5, token);

        if (string.IsNullOrEmpty(value))
            return oriention;
        return oriention.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }

    private async Task<IEnumerable<string>> SearcDiocese(string value, CancellationToken token)
    {
        await Task.Delay(5, token);

        switch (selectedOriention)
        {
            case "Автокафельная":
                if (string.IsNullOrEmpty(value))
                    return dioceseAvto;
                return dioceseAvto.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));
                break;
            case "Обновличенская":
                if (string.IsNullOrEmpty(value))
                    return dioceseObnov;
                return dioceseObnov.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));
                break;
            case "Тихоновская":
                if (string.IsNullOrEmpty(value))
                    return dioceseAvto;
                return dioceseAvto.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));
                break;
                default:
                if (string.IsNullOrEmpty(value))
                    return dioceseAvto;
                return dioceseAvto.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));
                break;
        }
    }

    private async Task<IEnumerable<string>> SearchProvince(string value, CancellationToken token)
    {
        await Task.Delay(5, token);

        if (string.IsNullOrEmpty(value))
            return provinces;
        return provinces.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }
    
    private async Task<IEnumerable<string>> SearchDistrict(string value, CancellationToken token)
    {
        await Task.Delay(5, token);

        if (string.IsNullOrEmpty(value))
            return districts;
        return districts.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }

    private async Task Sumbit()
    {
        string url = $"https://catalog.api.2gis.com/3.0/items/geocode?lon={defPosition.Lng}&lat={defPosition.Lat}&fields=items.point&key=2c437b2b-790f-4f22-9ec5-3889ea3e0bc4";

        using HttpClient client = new HttpClient();
        HttpResponseMessage response = await client.GetAsync(url.Replace(",", "."));

        if (response.IsSuccessStatusCode)
        {
            string content = await response.Content.ReadAsStringAsync();
            Console.WriteLine(content);

            var data = JsonConvert.DeserializeObject<dynamic>(content);

            // Получение списка элементов
            var items = data.result.items;

            // Цикл по всем элементам
            foreach (var item in items)
            {
                Console.WriteLine($"Full Name: {item.full_name}");
                Console.WriteLine($"Name: {item.name}");
                Console.WriteLine($"Subtype: {item.subtype}");
                Console.WriteLine();
                _temple.Province = item.full_name;

                break;
            }

            _temple.AppointmentsAfterEnd.Id = Guid.NewGuid().ToString("N");
            _temple.Oriention.Id = Guid.NewGuid().ToString("N");
            _temple.Id = Guid.NewGuid().ToString("N");
            
            _temple.FillEmptyFields();

            _context.Temples.Add(_temple);
            _context.SaveChanges();
            
            NavigationManager.NavigateTo("/?show=true", true);
        }
    }
}